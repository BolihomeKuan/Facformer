{% extends 'shrimp_app/base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'shrimp_app:index' %}">Home</a></li>
            <li class="breadcrumb-item">
                <a href="{% url 'shrimp_app:shrimp_detail' storage.shrimp_species.id %}">
                    {{ storage.shrimp_species.name }}
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'shrimp_app:shrimp_source_detail' storage.shrimp_species.id storage.shrimp_source.id %}">
                    {{ storage.shrimp_source.source_code }}
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'shrimp_app:storage_detail' storage.id %}">Storage Details</a>
            </li>
            <li class="breadcrumb-item active">{{ feature_type.name }} Data</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h3 class="mb-0">{{ feature_type.name }} Measurements</h3>
            <p class="text-white mb-0">
                For {{ storage.shrimp_species.name }} at {{ storage.temperature }}Â°C
            </p>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="featureDataTable">
                    <thead>
                        <tr>
                            <th>Measurement Day</th>
                            <th>Value</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in feature_data %}
                        <tr>
                            <td>{{ data.measurement_day }}</td>
                            <td>{{ data.value }}</td>
                            <td>{{ data.notes|default:"-" }}</td>
                            <td>
                                <div class="btn-group">
                                    {% if user.is_authenticated %}
                                    <a href="{% url 'shrimp_app:edit_feature_data' data.id %}" 
                                       class="btn btn-sm btn-danger">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="confirmDeleteFeature('{{ data.id }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if feature_data %}
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h3 class="mb-0">Data Visualization</h3>
        </div>
        <div class="card-body">
            <canvas id="featureChart"></canvas>
        </div>
    </div>
    {% endif %}
</div>

<style>
.btn-danger {
    background-color: #FF4D4D;
    border-color: #FF4D4D;
}

.btn-danger:hover {
    background-color: #CC3333;
    border-color: #CC3333;
}

.btn-outline-danger {
    color: #FF4D4D;
    border-color: #FF4D4D;
}

.btn-outline-danger:hover {
    background-color: #FF4D4D;
    border-color: #FF4D4D;
    color: white;
}

.card-header.bg-danger {
    background-color: #FF4D4D !important;
}

.table tbody tr:hover {
    background-color: rgba(255, 77, 77, 0.05);
}

.breadcrumb a {
    color: #FF4D4D;
    text-decoration: none;
}

.breadcrumb a:hover {
    color: #CC3333;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    $('#featureDataTable').DataTable({
        "pageLength": 10,
        "order": [[0, "asc"]],
        "language": {
            "search": "Search measurements:",
            "lengthMenu": "Show _MENU_ measurements per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ measurements"
        }
    });

    {% if feature_data %}
    const ctx = document.getElementById('featureChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: [{% for data in feature_data %}'Day {{ data.measurement_day }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: '{{ feature_type.name }}',
                data: [{% for data in feature_data %}{{ data.value }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                borderColor: '#FF4D4D',
                backgroundColor: 'rgba(255, 77, 77, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
    {% endif %}
});

function confirmDeleteFeature(featureId) {
    if (confirm('Are you sure you want to delete this measurement?')) {
        fetch(`/shrimp/feature/${featureId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}